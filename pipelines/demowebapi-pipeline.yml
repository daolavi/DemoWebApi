trigger:
  - main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  azureSubscription: 'rm-service-connection'
  solution: '**/*.sln'
  dotNetVersion: '8.x'

stages:
  - stage: BuildAndTest
    displayName: 'Build and Test'
    jobs:
      - template: restore-build-test.yml
        parameters:
          solution: $(solution)
          buildConfiguration: $(buildConfiguration)
          dotNetVersion: $(dotNetVersion)

  - stage: DeployToStaging
    displayName: 'Deploy to Staging'
    dependsOn: BuildAndTest
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: deploy.yml
        parameters:
          environment: 'staging'
          azureSubscription: $(azureSubscription)
          appServiceName: 'demo-web-api-staging'
          dotNetVersion: $(dotNetVersion)

  - stage: DeployToProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployToStaging
    condition: false
    #condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: deploy.yml
        parameters:
          environment: 'production'
          azureSubscription: $(azureSubscription)
          appServiceName: 'demo-web-api-production'
          dotNetVersion: $(dotNetVersion)
